name: Deploy to EC2

on:
  workflow_dispatch:
    inputs:
      force_db_sync:
        description: 'Force sync database from host (overwrite container volume)'
        required: false
        type: boolean
        default: false
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'docker-compose.yml'
      - 'nginx.conf'
      - '.github/workflows/deploy.yml'
      - 'app_code/**'
      - 'shiny-server.conf'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          command_timeout: 30m
          script: |
            set -euo pipefail

            cd /home/ubuntu/T_cell_atlas_aws
            git fetch origin
            git checkout main
            git reset --hard origin/main
            git clean -xdf

            echo "üì¶ Ensuring docker-compose is installed..."
            if ! command -v docker-compose &> /dev/null; then
              sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
              sudo chmod +x /usr/local/bin/docker-compose
            fi

            echo "üßπ Stopping existing containers..."
            docker-compose down || true

            echo "üîç Freeing port 80..."
            # Kill any process using port 80
            sudo lsof -ti:80 | xargs -r sudo kill -9 || true
            
            # Also check for docker containers on port 80
            CONTAINER_ID=$(docker ps -a --filter "publish=80" --format "{{.ID}}" | head -1)
            if [ -n "${CONTAINER_ID:-}" ]; then
              echo "  Found container using port 80: $CONTAINER_ID, removing..."
              docker stop "$CONTAINER_ID" || true
              docker rm "$CONTAINER_ID" || true
            fi
            
            # Give it a moment
            sleep 2

            echo "üõ† Building images with cache..."
            docker-compose build --pull

            echo "üîê Verifying port 80 is free..."
            if sudo lsof -ti:80 >/dev/null 2>&1; then
              echo "‚ùå Port 80 is still in use!"
              sudo lsof -i:80
              exit 1
            fi
            echo "‚úì Port 80 is free"

            echo "üöÄ Starting multi-container stack..."
            docker-compose up -d --remove-orphans

            echo "üìã Initializing user database..."
            # Check if force sync is requested or if database doesn't exist
            if [ "${{ github.event.inputs.force_db_sync }}" = "true" ]; then
              echo "  üîÑ Force sync requested - overwriting volume with host DB..."
              if [ -f /home/ubuntu/atlas/data/users_current.sqlite ]; then
                docker run --rm \
                  -v t_cell_atlas_aws_users-db:/data \
                  -v /home/ubuntu/atlas/data:/source \
                  alpine cp /source/users_current.sqlite /data/users_current.sqlite
                
                docker run --rm \
                  -v t_cell_atlas_aws_users-db:/data \
                  alpine chmod 666 /data/users_current.sqlite
                
                echo "  ‚úì Database synced from host"
              else
                echo "  ‚ùå Source database not found at /home/ubuntu/atlas/data/users_current.sqlite"
              fi
            elif docker run --rm -v t_cell_atlas_aws_users-db:/data alpine test -f /data/users_current.sqlite 2>/dev/null; then
              echo "  ‚úì Database already exists in volume (not overwriting)"
            else
              echo "  Copying users database from host to Docker volume..."
              if [ -f /home/ubuntu/atlas/data/users_current.sqlite ]; then
                docker run --rm \
                  -v t_cell_atlas_aws_users-db:/data \
                  -v /home/ubuntu/atlas/data:/source \
                  alpine cp /source/users_current.sqlite /data/users_current.sqlite
                
                echo "  Setting database permissions..."
                docker run --rm \
                  -v t_cell_atlas_aws_users-db:/data \
                  alpine chmod 666 /data/users_current.sqlite
                
                echo "  ‚úì Database initialized"
              else
                echo "  ‚ö†Ô∏è  Warning: Source database not found at /home/ubuntu/atlas/data/users_current.sqlite"
              fi
            fi
            
            echo "üìÅ Ensuring database directory is writable..."
            docker run --rm \
              -v t_cell_atlas_aws_users-db:/data \
              alpine chmod 777 /data

            echo "‚è≥ Waiting for containers to be healthy (max 120s)..."
            MAX_ATTEMPTS=60
            ATTEMPT=0
            while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
              HEALTHY_COUNT=$(docker-compose ps | grep -c "healthy" || true)
              TOTAL_COUNT=$(docker-compose ps | grep -c "shiny-app" || true)
              
              if [ "$HEALTHY_COUNT" -eq 3 ] && [ "$TOTAL_COUNT" -eq 3 ]; then
                echo "‚úì All containers healthy!"
                break
              fi
              
              echo "  [$(($ATTEMPT + 1))/$MAX_ATTEMPTS] Healthy: $HEALTHY_COUNT/3 containers"
              sleep 2
              ATTEMPT=$((ATTEMPT + 1))
            done

            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo "‚ö†Ô∏è  Health check timeout after 120s"
            fi

            echo "ü©∫ Final health check via HTTP..."
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt 5 ]; do
              if curl -sSf http://localhost/atlas/ >/dev/null 2>&1; then
                echo "‚úì HTTP health check passed!"
                break
              fi
              echo "  Attempt $((RETRY_COUNT + 1))/5 failed, retrying..."
              sleep 3
              RETRY_COUNT=$((RETRY_COUNT + 1))
            done

            if [ $RETRY_COUNT -eq 5 ]; then
              echo "‚ùå HTTP health check failed after 5 attempts"
              echo "Container status:"
              docker-compose ps
              echo "Nginx logs:"
              docker-compose logs --tail=30 nginx
              echo "App 1 logs:"
              docker-compose logs --tail=30 shiny-app-1
              exit 1
            fi

            echo "‚úÖ Deployed successfully!"
            echo "üìä Final Container Status:"
            docker-compose ps
            
            echo "üßπ Cleaning up old images..."
            docker image prune -f || true
